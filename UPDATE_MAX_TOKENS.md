# 修复输出截断问题 - 添加 max_tokens 配置

## 🐛 问题描述

Agent在输出较长回复时被截断，输出到一半就停止了。

**症状**：
```
...这样您
```
（输出突然中断）

## 🔍 原因分析

Bedrock模型默认的 `max_tokens` 设置过小，导致模型输出被限制。

Claude Opus 4.5 模型可以支持更长的输出，但需要显式配置 `max_tokens` 参数。

## ✅ 解决方案

### 1. 添加 max_tokens 配置到 BedrockModel

**文件**: `agent_manager.py`

```python
# 之前
model = BedrockModel(model_id=model_id)

# 修复后
model = BedrockModel(
    model_id=model_id,
    max_tokens=4096,  # 设置最大输出token数
    temperature=0.7   # 设置温度参数
)
```

### 2. 在UI中添加可配置选项

**文件**: `app.py`

在左侧栏的模型配置区域添加：

```python
max_tokens = st.number_input(
    "最大输出Token数",
    min_value=512,
    max_value=8192,
    value=4096,
    step=512,
    help="控制模型单次回复的最大长度"
)
```

### 3. 更新 Agent 初始化流程

**修改内容**:
- `ExcelColorAgent.__init__` 添加 `max_tokens` 参数
- `create_agent()` 函数添加 `max_tokens` 参数
- 调用 `create_agent()` 时传递 `max_tokens` 值

## 📊 配置说明

### max_tokens 取值范围

| 值 | 适用场景 |
|----|---------|
| 512 | 简短回复（几句话） |
| 1024 | 中等长度回复 |
| 2048 | 较长回复（几段文字） |
| 4096 | 长回复（默认，推荐） |
| 8192 | 超长回复（详细分析报告） |

### 推荐配置

- **默认值**: 4096 tokens
- **适用场景**:
  - Excel分析结果展示
  - 详细的数据范围说明
  - 完整的操作步骤描述

### Token 消耗说明

**示例输出**（约 300 个中文字）：
```
✅ 色阶应用完成！

我已成功为 Sheet1 的数据刷上了三色色阶，具体信息如下：

| 项目 | 详情 |
|------|------|
| **应用范围** | B3:E49 |
| **影响单元格** | 188个 |
...

这样您可以快速识别各AWS服务的成本高低：
- 高成本服务会显示为绿色
- 中等成本显示为黄色
- 低成本服务显示为红色

请点击下方的下载按钮获取处理后的Excel文件！
```

**Token 消耗**: 约 400-500 tokens

## 🔧 验证

启动应用后，你应该能看到：

1. **左侧栏**：新增"最大输出Token数"配置项
2. **Agent回复**：不再被截断，能够完整输出
3. **完整信息**：包括表格、说明和下载提示

## 💡 使用建议

### 什么时候需要调整 max_tokens？

**增大 max_tokens (4096 → 8192)**：
- Agent回复仍然被截断
- 需要更详细的分析报告
- 处理多个sheet的复杂表格

**减小 max_tokens (4096 → 2048)**：
- 追求更快的响应速度
- 只需要简短确认信息
- 成本优化（减少token消耗）

### 其他模型参数

除了 `max_tokens`，还可以调整：

**temperature** (0.0 - 1.0):
- 0.0: 更确定、保守的输出
- 0.7: 平衡（当前默认）
- 1.0: 更有创意、多样化的输出

如果需要调整 temperature，修改 `agent_manager.py`:
```python
model = BedrockModel(
    model_id=model_id,
    max_tokens=self.max_tokens,
    temperature=0.5  # 修改这里
)
```

## 📝 相关文件

修改的文件列表：
- ✅ `agent_manager.py` - 添加 max_tokens 配置
- ✅ `app.py` - UI添加配置选项，传递参数

## 🧪 测试

```bash
# 测试导入
python3 -c "import app; print('✅ 导入成功')"

# 启动应用
streamlit run app.py
```

测试步骤：
1. 启动应用
2. 查看左侧栏是否有"最大输出Token数"配置
3. 上传Excel文件
4. 输入："为Sheet1的数据刷色阶，并详细说明应用的范围和效果"
5. 验证输出是否完整，不被截断

## 🎯 效果对比

### 修复前
```
✅ 完成！已为Sheet1的B3:E49区域（188个单元格）应用三色色阶。

这样您
```
（输出被截断）

### 修复后
```
✅ 色阶应用完成！

我已成功为 Sheet1 的数据刷上了三色色阶，具体信息如下：

| 项目 | 详情 |
|------|------|
| **应用范围** | B3:E49 |
| **影响单元格** | 188个 |
| **色阶类型** | 三色渐变（three_color） |
| **配色方案** | 红 → 黄 → 绿 |

**色阶效果说明：**
- 🔴 红色：代表较低的数值
- 🟡 黄色：代表中间数值
- 🟢 绿色：代表较高的数值

这样您可以快速识别各AWS服务的成本高低。请点击下方的下载按钮获取处理后的Excel文件！
```
（完整输出）

---

**问题已解决！** 🎉
